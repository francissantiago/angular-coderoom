
<main 
  class="h-screen w-screen text-gray-900 dark:text-white flex flex-col bg-gray-100 dark:bg-[#252526] relative overflow-hidden transition-colors duration-300"
  (keydown.control.s)="$event.preventDefault(); saveCode()"
  (keydown.meta.s)="$event.preventDefault(); saveCode()"
  (mousemove)="onDrag($event)"
  (mouseup)="stopDrag()"
  (mouseleave)="stopDrag()">
  
  <!-- Only show content if Logged In -->
  @if(currentUser()) {
    <!-- Top-level Header -->
    <header class="flex-shrink-0 p-2 md:px-4 md:py-3 bg-white dark:bg-[#1e1e1e] flex justify-between items-center border-b border-gray-300 dark:border-gray-700 shadow-sm dark:shadow-none transition-colors">
        <div class="flex items-center gap-4">
            <h1 class="text-xl font-bold text-gray-800 dark:text-gray-200">Angular CodeRoom</h1>
            @if(activeProject()) {
            <button (click)="deselectProject()" class="text-sm text-blue-600 dark:text-cyan-400 hover:text-blue-500 dark:hover:text-cyan-300 transition-colors flex items-center gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
                Projetos
            </button>
            }
        </div>
        <div class="flex items-center gap-4">
            <!-- Theme Toggle -->
            <button (click)="toggleTheme()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-gray-600 dark:text-yellow-400" title="Alternar Tema">
                @if(isDarkMode() === 'dark') {
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                } @else {
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                }
            </button>

            <div class="text-right hidden sm:block">
                <p class="text-sm font-bold text-gray-800 dark:text-white">{{ currentUser()?.name }}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400 capitalize">{{ userRole() === 'student' ? 'Aluno' : 'Professor' }}</p>
            </div>
            <button (click)="logout()" class="text-sm font-semibold py-1 px-3 rounded-md bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 hover:bg-red-200 dark:hover:bg-red-900 transition-colors border border-red-200 dark:border-red-900 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                Sair
            </button>
        </div>
    </header>

    <!-- View Container -->
    <div class="flex-grow min-h-0 relative z-0">
        @if (!activeProject()) {
        <!-- ==================== DASHBOARD VIEW ==================== -->
        @switch(userRole()) {
            @case('student') {
            <app-student-dashboard (selectProject)="selectProject($event)" />
            }
            @case('teacher') {
            <app-teacher-dashboard (selectProject)="selectProject($event)" />
            }
        }
        } @else {
        <!-- ==================== CODEROOM VIEW ==================== -->
        @switch(userRole()) {
            @case('student') {
            <!-- STUDENT CODEROOM -->
            <div class="p-2 md:p-4 h-full">
                <div class="h-full flex-grow grid grid-cols-1 lg:grid-cols-2 gap-4 min-h-0">
                <!-- Left Panel: Unified Editor -->
                <div class="flex flex-col bg-white dark:bg-[#2d2d2d] rounded-lg overflow-hidden min-h-0 border border-gray-300 dark:border-gray-700 shadow-md dark:shadow-none">
                    <div class="flex-shrink-0 bg-gray-50 dark:bg-gray-900/50 p-3 border-b border-gray-300 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-4">
                                <h2 class="text-lg font-bold text-gray-800 dark:text-white">{{ activeProject()?.name }}</h2>
                                <button (click)="toggleTeacherCode()" class="text-blue-600 dark:text-cyan-400 hover:text-blue-500 dark:hover:text-cyan-300 transition-colors px-2 rounded font-semibold text-sm">
                                @if(showTeacherCode()) { Ocultar código do professor } @else { Exibir código do professor }
                                </button>
                            </div>
                            <div class="flex items-center gap-2">
                                <button (click)="formatCode()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-1 px-3 rounded-md text-xs transition-colors">Formatar</button>
                                <button (click)="saveCode()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded-md text-xs transition-colors">Salvar</button>
                            </div>
                        </div>
                        @if(activeProject()?.description) {
                            <p class="text-xs text-gray-500 dark:text-gray-400 line-clamp-2" [title]="activeProject()?.description">{{ activeProject()?.description }}</p>
                        }
                    </div>
                    
                    <div class="bg-gray-100 dark:bg-[#3c3c3c] border-b border-gray-300 dark:border-gray-700">
                    <nav class="flex space-x-1" aria-label="Tabs">
                        <button (click)="setTab('html')" [class]="activeTab() === 'html' ? 'bg-white dark:bg-[#1e1e1e] text-blue-600 dark:text-white border-t border-x border-gray-300 dark:border-gray-600 dark:border-b-0' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700/50'" class="px-3 py-2 font-medium text-sm rounded-t-md">HTML</button>
                        <button (click)="setTab('css')" [class]="activeTab() === 'css' ? 'bg-white dark:bg-[#1e1e1e] text-blue-600 dark:text-white border-t border-x border-gray-300 dark:border-gray-600 dark:border-b-0' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700/50'" class="px-3 py-2 font-medium text-sm rounded-t-md">CSS</button>
                        <button (click)="setTab('js')" [class]="activeTab() === 'js' ? 'bg-white dark:bg-[#1e1e1e] text-blue-600 dark:text-white border-t border-x border-gray-300 dark:border-gray-600 dark:border-b-0' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700/50'" class="px-3 py-2 font-medium text-sm rounded-t-md">JS</button>
                    </nav>
                    </div>
                    <div class="flex-grow min-h-0" [class]="showTeacherCode() ? 'grid grid-cols-2 gap-px bg-gray-300 dark:bg-gray-700' : 'block h-full'">
                    @if (studentCode(); as sCode) {
                        <div class="h-full">
                        @switch (activeTab()) {
                            @case ('html') { <app-editor [code]="sCode.html" (codeChange)="updateCode('html', $event)" title="Meu HTML" language="html" /> }
                            @case ('css') { <app-editor [code]="sCode.css" (codeChange)="updateCode('css', $event)" title="Meu CSS" language="css" /> }
                            @case ('js') { <app-editor [code]="sCode.js" (codeChange)="updateCode('js', $event)" title="Meu JavaScript" language="js" /> }
                        }
                        </div>
                    }
                    @if (showTeacherCode() && teacherCode(); as tCode) {
                        <div class="h-full">
                        @switch (activeTab()) {
                            @case ('html') { <app-editor [code]="tCode.html" title="HTML do Professor" language="html" [isReadOnly]="true" /> }
                            @case ('css') { <app-editor [code]="tCode.css" title="CSS do Professor" language="css" [isReadOnly]="true" /> }
                            @case ('js') { <app-editor [code]="tCode.js" title="JavaScript do Professor" language="js" [isReadOnly]="true" /> }
                        }
                        </div>
                    }
                    </div>
                </div>
                <!-- Right Panel: Preview -->
                <div class="flex flex-col min-h-0">
                    <div class="flex-grow bg-white dark:bg-[#2d2d2d] rounded-lg overflow-hidden min-h-0 h-full border border-gray-300 dark:border-gray-700 shadow-md dark:shadow-none" [class.pointer-events-none]="isDragging()"> <app-preview [document]="previewDocument()" /> </div>
                </div>
                </div>
            </div>
            }
            @case('teacher') {
            <!-- TEACHER CODEROOM -->
            <div class="h-full flex">
                <!-- Left Sidebar: Student List & Grading -->
                <aside class="w-64 flex-shrink-0 bg-white dark:bg-[#2d2d2d] border-r border-gray-300 dark:border-gray-700 flex flex-col shadow-md z-10">
                <!-- Header -->
                <div class="p-4 border-b border-gray-300 dark:border-gray-700 flex-shrink-0">
                    <h2 class="text-lg font-bold text-gray-800 dark:text-white truncate">{{ activeProject()?.name }}</h2>
                    @if(activeProject()?.description) {
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 line-clamp-3">{{ activeProject()?.description }}</p>
                    }
                    <h3 class="text-sm font-semibold text-blue-600 dark:text-cyan-400 mt-4">Alunos</h3>
                </div>
                
                <!-- Student List -->
                <ul class="flex-grow overflow-y-auto p-2 bg-gray-50 dark:bg-[#2d2d2d]">
                    <li>
                    <button (click)="selectStudent(null)" class="w-full text-left px-3 py-2 rounded-md flex items-center gap-2 mb-1" [class]="!codeService.viewedStudentId() ? 'bg-purple-600 text-white' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700'">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                        Meu Código
                    </button>
                    </li>
                    @for (student of activeProject()?.studentSubmissions; track student.studentId) {
                    <li>
                        <button (click)="selectStudent(student.studentId)" class="w-full text-left px-3 py-2 rounded-md" [class]="codeService.viewedStudentId() === student.studentId ? 'bg-purple-600 text-white' : 'text-gray-600 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700'">
                        {{ student.studentName }}
                        </button>
                    </li>
                    }
                </ul>

                <!-- Grading Panel (Only visible when student selected) -->
                @if(codeService.viewedStudentId()) {
                    <div class="p-4 border-t border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-[#252526] flex-shrink-0">
                    <h3 class="font-bold text-gray-800 dark:text-white mb-2 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-600 dark:text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                        Avaliação
                    </h3>
                    <div class="mb-3">
                        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Nota (0-100)</label>
                        <input 
                        type="number" 
                        min="0" max="100"
                        class="w-full bg-white dark:bg-[#3c3c3c] border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-sm text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-purple-500"
                        [value]="gradeInput()"
                        (input)="onGradeInput($event)"
                        />
                    </div>
                    <div class="mb-3">
                        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Feedback</label>
                        <textarea 
                        class="w-full bg-white dark:bg-[#3c3c3c] border border-gray-300 dark:border-gray-600 rounded px-2 py-1 text-xs text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-purple-500 min-h-[80px]"
                        placeholder="Comentários sobre o código..."
                        [value]="feedbackInput()"
                        (input)="onFeedbackInput($event)"
                        ></textarea>
                    </div>
                    <button 
                        (click)="submitGrade()" 
                        class="w-full bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 rounded transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        Salvar Avaliação
                    </button>
                    </div>
                }
                </aside>
                <!-- Main Content: Editor & Preview -->
                <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-4 min-h-0 p-4">
                <!-- Editor Panel -->
                <div class="flex flex-col bg-white dark:bg-[#2d2d2d] rounded-lg overflow-hidden min-h-0 border border-gray-300 dark:border-gray-700 shadow-md dark:shadow-none">
                    <div class="bg-gray-100 dark:bg-[#3c3c3c] border-b border-gray-300 dark:border-gray-700">
                    <nav class="flex space-x-1" aria-label="Tabs">
                        <button (click)="setTab('html')" [class]="activeTab() === 'html' ? 'bg-white dark:bg-[#1e1e1e] text-blue-600 dark:text-white border-t border-x border-gray-300 dark:border-gray-600 dark:border-b-0' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700/50'" class="px-3 py-2 font-medium text-sm rounded-t-md">HTML</button>
                        <button (click)="setTab('css')" [class]="activeTab() === 'css' ? 'bg-white dark:bg-[#1e1e1e] text-blue-600 dark:text-white border-t border-x border-gray-300 dark:border-gray-600 dark:border-b-0' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700/50'" class="px-3 py-2 font-medium text-sm rounded-t-md">CSS</button>
                        <button (click)="setTab('js')" [class]="activeTab() === 'js' ? 'bg-white dark:bg-[#1e1e1e] text-blue-600 dark:text-white border-t border-x border-gray-300 dark:border-gray-600 dark:border-b-0' : 'text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700/50'" class="px-3 py-2 font-medium text-sm rounded-t-md">JS</button>
                    </nav>
                    </div>
                    @if(teacherEditorCode(); as edCode) {
                    <div class="flex-grow min-h-0">
                        @switch (activeTab()) {
                        @case ('html') { <app-editor [code]="edCode.html" [title]="teacherEditorTitle()" language="html" [isReadOnly]="!!codeService.viewedStudentId()" /> }
                        @case ('css') { <app-editor [code]="edCode.css" [title]="teacherEditorTitle()" language="css" [isReadOnly]="!!codeService.viewedStudentId()" /> }
                        @case ('js') { <app-editor [code]="edCode.js" [title]="teacherEditorTitle()" language="js" [isReadOnly]="!!codeService.viewedStudentId()" /> }
                        }
                    </div>
                    }
                </div>
                <!-- Right Panel: Preview -->
                <div class="flex flex-col min-h-0">
                    <div class="flex-grow bg-white dark:bg-[#2d2d2d] rounded-lg overflow-hidden min-h-0 h-full border border-gray-300 dark:border-gray-700 shadow-md dark:shadow-none" [class.pointer-events-none]="isDragging()">
                    <app-preview [document]="previewDocument()" />
                    </div>
                </div>
                </div>
            </div>
            }
        }
        }
    </div>

    <!-- Floating Chat Button -->
    @if(activeProject()) {
        <button 
        (click)="toggleChat()"
        class="fixed bottom-6 right-6 z-50 w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-transform hover:scale-110 focus:outline-none"
        [class]="isChatOpen() ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-600 hover:bg-blue-700'"
        title="Abrir/Fechar Chat">
        @if(isChatOpen()) {
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        } @else {
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
            </svg>
        }
        </button>

        <!-- Floating Chat Window -->
        @if(isChatOpen()) {
        <div 
            class="floating-chat-container fixed z-40 w-80 h-96 rounded-lg shadow-2xl overflow-hidden flex flex-col border border-gray-300 dark:border-gray-600 bg-white dark:bg-[#1e1e1e]"
            [style.left.px]="chatPosition().x || null"
            [style.top.px]="chatPosition().y || null"
            [style.bottom.px]="(chatPosition().x === 0 && chatPosition().y === 0) ? 90 : null"
            [style.right.px]="(chatPosition().x === 0 && chatPosition().y === 0) ? 24 : null"
        >
            <!-- Drag Handle Overlay on Chat Header -->
            <div 
            (mousedown)="startDrag($event)" 
            class="absolute top-0 left-0 right-0 h-10 z-50 cursor-move bg-transparent hover:bg-black/5 dark:hover:bg-white/5 transition-colors"
            title="Arraste para mover">
            </div>

            <!-- Chat Component -->
            <app-chat [role]="userRole() === 'student' ? 'Student' : 'Teacher'" />
        </div>
        }
    }

    <!-- Save Toast Notification -->
    <div class="fixed top-20 left-1/2 -translate-x-1/2 bg-green-600 text-white font-semibold py-2 px-5 rounded-lg shadow-lg flex items-center gap-2 transition-all duration-300 ease-in-out z-50"
        [class.opacity-100]="showSaveToast()" [class.translate-y-0]="showSaveToast()"
        [class.opacity-0]="!showSaveToast()" [class.-translate-y-8]="!showSaveToast()"
        [class.pointer-events-none]="!showSaveToast()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
        </svg>
        <span>Salvo!</span>
    </div>
  } @else {
    <!-- LOGIN VIEW -->
    <app-login />
  }
</main>
